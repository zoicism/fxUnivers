<?php

session_start();
require('wallet_connect.php');

if(isset($_POST['numOfFxCoins'])) $amnt = $_POST['numOfFxCoins'];

function generateRandomString($length) {
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $charactersLength = strlen($characters);
    $randomString = '';
    for ($j = 0; $j < $length; $j++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }
    return $randomString;
}


for($i=0; $i<$amnt; $i++) {

//$hashed = hash(sha256, bin2hex(random_bytes(64)), false);

    $hashed=hash(sha256, generateRandomString(64), false);
    
    $buy_coin_query = "INSERT INTO fxcoin(hash) VALUES('$hashed')";
    $buy_coin_result = mysqli_query($wallet_connection, $buy_coin_query) or die(mysqli_error($wallet_connection));

    $hashed_coin_id_query = "SELECT id FROM fxcoin WHERE hash='$hashed'";
    $hashed_coin_id_result = mysqli_query($wallet_connection, $hashed_coin_id_query) or die(mysqli_error($wallet_connection));
    $hashed_coin_id_fetch = mysqli_fetch_array($hashed_coin_id_result);
    $hashed_coin_id = $hashed_coin_id_fetch['id'];
    
    if($buy_coin_result) {
        require('../../register/connect.php');
        $username = $_SESSION['username'];
        require('../../php/get_user.php');
        
        $link_query = "INSERT INTO link(fxCoinId, userId) VALUES($hashed_coin_id, $get_user_id)";
        $link_result = mysqli_query($wallet_connection, $link_query) or die(mysqli_error($wallet_connection));
    }
}

// current dt
date_default_timezone_set('America/New_York');
$trans_dt=date('Y-m-d H:i:s');

// set transfer data
$trans_from=1;
$trans_to=$get_user_id;
$trans_amnt=$amnt;
$trans_query="INSERT INTO transactions(from_id, to_id, amnt, dt) VALUES($trans_from, $trans_to, $trans_amnt, '$trans_dt')";
$trans_result=mysqli_query($wallet_connection, $trans_query) or die(mysqli_error($wallet_connection));

//header("Location: /wallet");
?>