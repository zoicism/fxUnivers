<?php
session_start();
require('../connect.php');

if(isset($_SESSION['username'])) {
    header('Location: /register/logout.php');
    exit();
}

if(isset($_POST['email'])) {
    $email=$_POST['email'];
} else {
    header('Location: /');
    exit();
}

$checkex_q="SELECT * FROM user WHERE email='$email'";
$checkex_r=mysqli_query($connection,$checkex_q) or die(mysqli_error($connection));
$checkex_count=mysqli_num_rows($checkex_r);
if($checkex_count<1) {
    header('Location: /register/forgot_password?err=no_res');
    exit();
}

$hash = md5(rand(0,1000)); // Random 32-char hash

$forgot_q = "INSERT INTO forgot_pass(email, hash) VALUES('$email', '$hash')";
$forgot_r = mysqli_query($connection, $forgot_q) or die(mysqli_error($connection));


// RECOVERY EMAIL //

$to=$email;
$subject='fxUnivers Password Recovery';
$msg_link='https://fxunivers.com/register/forgot_password/recover.php?email='.$email.'&hash='.$hash;
$message = '
<html>
<head><title>fxUniversity Password Recovery</title></head>
<body>
<p>Dear fxUser,</p>
<p>Click on the following link to set yourself a new password.</p>
<p><a href="'.$msg_link.'">'.$msg_link.'</a></p>
<p><i>With <3,<br>fxTeam</i></p>
</html>
';

// headers
$headers[] = 'MIME-Version: 1.0';
$headers[] = 'Content-type: text/html; charset=iso-8859-1';

// additional headers
$headers[] = 'From: fxTeam <no-reply@fxunivers.com>';

// EO recovery email //

if($forgot_r) {
    // Mail it!
    //mail($to, $subject, $message, implode("\r\n", $headers));
    $success=1;
} else {
    $success=0;
}


?>

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>fxUnivers</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">   
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/jquery-3.4.1.min.js"></script>
  </head>

<body>

<div class="center">
<?php
                if($success) {
                    echo '<h3>We have emailed you a password recovery link.</h3>';
                    echo '<p>Please check your inbox!</p>';
                    echo '<p><a href="https://mail.google.com" target="_blank">Gmail</a> - <a href="https://mail.yahoo.com" target="_blank">Yahoo Mail</a></p>';
                } else {
                    echo '<h3>Error :( <a href="/register/forgot_password">Try again!</a></h3>';
                }
?>
</div>

<div class="footer" style="bottom:0;position:fixed;"></div>
<script src="/js/footer.js"></script>
</body>
</html>